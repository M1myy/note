# Docker Swarm架构设计报告

## Docker Swarm

### Swarm背景

现实中我们的应用可能会有很多，应用本身也可能很复杂，单个Docker Engine所能提供的资源未必能够满足要求。而且应用本身也会有可靠性的要求，希望避免单点故障，这样的话势必需要分布在多个Docker Engine。在这样一个大背景下，Docker社区就产生了Swarm项目[1]。

### 什么是Docker Swarm

Swarm这个项目名称特别贴切。Swarm behavior是指动物的集体行为。比如我们常见的蜂群，鱼群，秋天往南飞的雁群都可以称作Swarm behavior。
Swarm项目正是这样，通过把多个Docker Engine聚集在一起，形成一个大的docker-engine，对外提供容器的集群服务。同时这个集群对外提供Swarm API，用户可以像使用Docker Engine一样使用Docker集群[1]。

### Swarm特点

- 对外以Docker API接口呈现，这样带来的好处是，如果现有系统使用Docker Engine，则可以平滑将Docker Engine切到Swarm上，无需改动现有系统。
- Swarm对用户来说，之前使用Docker的经验可以继承过来。非常容易上手，学习成本和二次开发成本都比较低。同时Swarm本身专注于Docker集群管理，非常轻量，占用资源也非常少。 **“Batteries included but swappable”**，简单说，就是插件化机制，Swarm中的各个模块都抽象出了API，可以根据自己一些特点进行定制实现。
- Swarm自身对Docker命令参数支持的比较完善，Swarm目前与Docker是同步发布的。Docker的新功能，都会第一时间在Swarm中体现[1]。

## 概要设计

### 系统质量需求

**一键伸缩**满足了业务爆发增长需求，Docker Swarm可以管理任意规模的应用。不管是10还是10000台服务器，Docker Swarm都可以在整个集群轻松实现弹性扩展。一键扩展应用实例，从而轻松应对业务的爆发式增长。

**资源池化**提高了资源利用率，传统的数据中心或云的资源利用率只有12-15%。Docker Swarm可以将集群资源池化，并将不同应用自动混合部署到整个集群，不受单个服务器边界限制，明显提升了资源利用率。平均可提升400%。混跑应用支持 Docker 容器化应用，以及 Spark、Hadoop、Cassandra 等多种分布式应用。

**混合云管理**支持多环境支持和无缝迁移，Docker Swarm可安装在公有云、私有云、混合云之上。支持物理机、虚拟机。可在多平台间无缝迁移。帮助用户保持统一的开发运维体验。

**一键部署**可以快速搭建企业生产环境，支持一键部署 Docker 容器化应用。（支持企业原有容器化应用，及 Docker Hub 等第三方平台的 Docker 镜像）；可一键部署 Spark、Hadoop、 Cassandra、Jenkins、Kafka 等多种常用分布式应用，从而快速搭建企业生产环境，开发流行的微服务和大数据应用。

**简化运维**可以快速实现 DevOps，打破开发和运维团队之间的障碍，提高应用开发、部署、维护效率。通过统一界面，管理应用和集群。可随时监控每一个应用，集群，主机的运行健康状态。提供 API 接口，可与多种第三方应用，或企业自有管理系统对接整合。可统一收集应用和集群主机日志，能够快速查询和检索，帮助企业快速定位问题。让用户像用单机电脑一样管理集群和云端应用。

**服务高可用**能实现自动容错，永不掉线，当开启高可用服务后，Docker Swarm自动为宕机服务器上运行的节点重新分配资源，保障业务不掉线，高可靠运行。这也就意味着您不用再为一两台服务器的宕机，而经历一个不眠之夜。

### 总体解决方案



### 架构模式/设计模式

### 模块设计/接口设计

### 关键流程时序图

## 详细设计

### 集群管理模块

Swarm Manager CLI用于集群管理。通过三步就可以将集群创建起来。

```sh
$ swarm create
$ swarm join --add=<node_ip> token://<token>
$ swarm manage -H=<manage_ip> token://<token>
```

Swarm容器集群创建完成后，就可以采用Docker命令，像使用Docker Engine一样使用Swarm集群创建容器了[1]。

### 服务发现模块

服务发现，在Swarm中主要用于节点发现，每一个节点上的Agent会将docker-egine的IP端口注册到服务发现系统中。Manager会从服务发现模块中读取节点信息。Swarm中服务发现支持已下3种类型的后端：

1. hosted discovery service，是Docker Hub提供的服务发现服务，需要连接外网访问。
2. KV分布式存储系统，现在已支持etcd、ZooKeeper、Consul三种。
3. 静态IP，可以使用本地文件或者直接指定节点IP，这种方式不需要启动额外使用其他组件,一般在调试中会使用到[1]。

### Scheduler

调度模块主要用户容器创建时，选择一个最优节点。在选择最优节点过程中，分为了两个阶段：
第一个阶段，是过滤。根据条件过滤出符合要求的节点，过滤器有以下5种：

1. Constraints，约束过滤器，可以根据当前操作系统类型、内核版本、存储类型等条件进行过滤，当然也可以自定义约束，在启动Daemon的时候，通过Label来指定当前主机所具有的特点。
2. Affnity，亲和性过滤器，支持容器亲和性和镜像亲和性，比如一个web应用，我想将DB容器和Web容器放在一起，就可以通过这个过滤器来实现。
3. Dependency，依赖过滤器。如果在创建容器的时候使用了–volume-from/–link/–net某个容器，则创建的容器会和依赖的容器在同一个节点上。
4. Health filter，会根据节点状态进行过滤，会去除故障节点。
5. Ports filter，会根据端口的使用情况过滤。

调度的第二个阶段是根据策略选择一个最优节点。有以下三种策略：

1. Binpack，在同等条件下，选择资源使用最多的节点，通过这一个策略，可以将容器聚集起来。
2. Spread，在同等条件下，选择资源使用最少的节点，通过这一个策略，可以将容器均匀分布在每一个节点上。
3. Random，随机选择一个节点[1]。

### Leadership

Leadership模块，这个模块主要用来提供Swarm Manager自身的HA。

为了防止Swarm Manager单点故障，引入了HA机制，Swarm Manager自身是无状态的，所以还是很容易实现HA的。 实现过程中采用主备方式，当主节点故障以后，会从新选主提供服务，选主过程中采用分布式锁实现，现在支持etcd、ZooKeeper、Consul三种类型的分布式存储，用来提供分布式锁。 当备节点收到消息后，会将消息转发给主节点[1]。

## 参考文献

[1] 线超博. DockOne技术分享（二十）：Docker三剑客之Swarm介绍[EB/OL]. http://dockone.io/article/662 . 2015-09-8.